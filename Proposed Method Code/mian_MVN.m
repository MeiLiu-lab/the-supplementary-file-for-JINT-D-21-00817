clc;
clear;
close all;
global T ra theta0 dot_theta_p dot_theta_n;
m=7;n=3;p=14;
T = 15; %任务总时长
a=2*pi;   %期望轨迹的周期

theta0=[-0.0000,-0.785472,-0.00,-2.35425,-0.0000,1.57164,0.785465]'; % theta 初始化
ra = forward_kinematics(theta0); %初始位置

u0=[zeros(m+n+p,1);theta0];
tspan=0:0.01:T;
options=odeset(); 
dot_theta_p = [2.1750;2.1750;2.1750;2.1750;2.6100;2.6100;2.6100];
dot_theta_n = -1*[2.1750;2.1750;2.1750;2.1750;2.6100;2.6100;2.6100];

[t,u1(:,:)]=ode45(@ZNN_j,tspan,u0,options,3); %satznn

ix = ra(1);
iy = ra(2);
iz = ra(3);
for i=1:length(tspan)
% 取出每一行的theta值
theta=(u1(i,m+n+p+1:n+m+p+m))';

%  根据前向运动学 计算出来 theta的末端位置
r=(forward_kinematics(theta));

%%kongfu
rx = 0.0001*(18/29 *sin(161/41 - 120*t(i)*a/T) + 21/52*sin(137/34 - 119*t(i)*a/T) + 10/31*sin(86/31 - 117*t(i)*a/T) + 9/32*sin(123/35 - 115*t(i)*a/T) + 8/23*sin(27/25 - 114*t(i)*a/T) + 9/31*sin(99/40 - 113*t(i)*a/T) + 5/29*sin(16/23 - 112*t(i)*a/T) + 19/28*sin(64/31 - 111*t(i)*a/T) + 1/27*sin(20/29 - 110*t(i)*a/T) + 32/53*sin(18/5 - 109*t(i)*a/T) + 4/19*sin(65/24 - 108*t(i)*a/T) + 1/8*sin(13/33 - 107*t(i)*a/T) + 3/23*sin(4/23 - 106*t(i)*a/T) + 8/17*sin(25/14 - 105*t(i)*a/T) + 8/13*sin(23/19 - 102*t(i)*a/T) + 7/12*sin(37/52 - 101*t(i)*a/T) + 8/29*sin(192/41 - 100*t(i)*a/T) + 41/81*sin(26/47 - 99*t(i)*a/T) + 11/40*sin(47/59 - 98*t(i)*a/T) + 31/35*sin(73/40 - 97*t(i)*a/T) + 11/34*sin(141/32 - 96*t(i)*a/T) + 11/24*sin(68/15 - 95*t(i)*a/T) + 11/14*sin(44/49 - 94*t(i)*a/T) + 3/35*sin(141/53 - 93*t(i)*a/T) + 4/25*sin(121/28 - 91*t(i)*a/T) + 19/40*sin(43/36 - 90*t(i)*a/T) + 43/42*sin(56/17 - 89*t(i)*a/T) + 5/8*sin(51/40 - 88*t(i)*a/T) + 15/31*sin(121/34 - 87*t(i)*a/T) + 3/8*sin(46/11 - 86*t(i)*a/T) + 5/18*sin(115/33 - 85*t(i)*a/T) + 17/18*sin(25/8 - 84*t(i)*a/T) + 37/33*sin(248/59 - 83*t(i)*a/T) + 44/43*sin(187/58 - 82*t(i)*a/T) + 38/39*sin(162/35 - 80*t(i)*a/T) + 5/7*sin(105/29 - 78*t(i)*a/T) + 17/37*sin(86/41 - 77*t(i)*a/T) + 16/21*sin(19/15 - 75*t(i)*a/T) + 9/8*sin(101/42 - 74*t(i)*a/T) + 26/31*sin(85/43 - 73*t(i)*a/T) + 131/75*sin(49/13 - 72*t(i)*a/T) + 27/29*sin(25/18 - 71*t(i)*a/T) + 32/31*sin(135/47 - 70*t(i)*a/T) + 73/30*sin(153/43 - 69*t(i)*a/T) + 1/12*sin(197/42 - 67*t(i)*a/T) + 26/29*sin(61/22 - 65*t(i)*a/T) + 23/28*sin(135/58 - 63*t(i)*a/T) + 112/39*sin(22/45 - 62*t(i)*a/T) + 15/23*sin(43/35 - 61*t(i)*a/T) + 29/34*sin(1/22 - 60*t(i)*a/T) + 30/43*sin(65/22 - 58*t(i)*a/T) + 19/30*sin(75/23 - 57*t(i)*a/T) + 15/26*sin(14/25 - 56*t(i)*a/T) + 28/23*sin(53/43 - 55*t(i)*a/T) + 14/43*sin(69/28 - 52*t(i)*a/T) + 50/37*sin(1623/406 - 50*t(i)*a/T) + 42/37*sin(211/45 - 49*t(i)*a/T) + 58/39*sin(45/22 - 47*t(i)*a/T) + 47/17*sin(106/33 - 46*t(i)*a/T) + 37/18*sin(103/30 - 43*t(i)*a/T) + 81/28*sin(58/13 - 42*t(i)*a/T) + 55/41*sin(39/14 - 40*t(i)*a/T) + 44/19*sin(23/32 - 39*t(i)*a/T) + 2038/291*sin(173/87 - 38*t(i)*a/T) + 98/31*sin(101/24 - 37*t(i)*a/T) + 133/30*sin(79/45 - 35*t(i)*a/T) + 151/55*sin(91/31 - 34*t(i)*a/T) + 171/28*sin(104/27 - 33*t(i)*a/T) + 124/17*sin(155/58 - 32*t(i)*a/T) + 61/12*sin(170/37 - 30*t(i)*a/T) + 196/41*sin(59/58 - 29*t(i)*a/T) + 67/15*sin(122/27 - 28*t(i)*a/T) + 146/39*sin(97/25 - 27*t(i)*a/T) + 106/19*sin(38/37 - 25*t(i)*a/T) + 193/26*sin(81/34 - 23*t(i)*a/T) + 608/33*sin(22/13 - 21*t(i)*a/T) + 97/33*sin(321/320 - 20*t(i)*a/T) + 647/27*sin(32/15 - 19*t(i)*a/T) + 336/17*sin(17/29 - 18*t(i)*a/T) + 452/35*sin(119/27 - 17*t(i)*a/T) + 353/35*sin(28/55 - 16*t(i)*a/T) + 955/36*sin(5/2 - 15*t(i)*a/T) + 923/43*sin(112/27 - 14*t(i)*a/T) + 493/33*sin(200/47 - 13*t(i)*a/T) + 1621/35*sin(33/50 - 12*t(i)*a/T) + 1221/34*sin(27/13 - 11*t(i)*a/T) + 1261/19*sin(71/38 - 8*t(i)*a/T) + 904/33*sin(55/42 - 6*t(i)*a/T) + 3596/21*sin(5/39 - 5*t(i)*a/T) + 716/5*sin(88/21 - 3*t(i)*a/T) + 6029/56*sin(14/19 - 2*t(i)*a/T) + 71761/66*sin(49/20 -t(i)*a/T) - 25601/58*sin(4*t(i)*a/T + 9/16) - 1179/8*sin(7*t(i)*a/T + 42/43) - 5801/100*sin(9*t(i)*a/T + 17/30) - 2518/29*sin(10*t(i)*a/T + 118/79) - 283/35*sin(22*t(i)*a/T + 37/28) - 143/16*sin(24*t(i)*a/T + 1/14) - 32/7*sin(26*t(i)*a/T + 1/376) - 33/13*sin(31*t(i)*a/T + 16/23) - 179/27*sin(36*t(i)*a/T + 1/130) - 128/25*sin(41*t(i)*a/T + 37/30) - 218/67*sin(44*t(i)*a/T + 14/31) - 74/39*sin(45*t(i)*a/T + 28/23) - 29/33*sin(48*t(i)*a/T + 1/6) - 6/11*sin(51*t(i)*a/T + 6/23) - 61/26*sin(53*t(i)*a/T + 23/57) - 17/10*sin(54*t(i)*a/T + 25/67) - 35/26*sin(59*t(i)*a/T + 37/33) - 49/50*sin(64*t(i)*a/T + 15/22) - 24/43*sin(66*t(i)*a/T + 13/11) - 18/11*sin(68*t(i)*a/T + 3/7) - 13/23*sin(76*t(i)*a/T + 32/23) - 15/16*sin(79*t(i)*a/T + 1/37) - 33/38*sin(81*t(i)*a/T + 19/25) - 9/25*sin(92*t(i)*a/T + 9/11) - 16/29*sin(103*t(i)*a/T + 48/55) - 7/46*sin(104*t(i)*a/T + 11/30) - 9/49*sin(116*t(i)*a/T + 28/55) - 21/37*sin(118*t(i)*a/T + 6/29) - 9/35*sin(121*t(i)*a/T + 2/19));
ry = 0.0001*(31/94*sin(54/17 - 121*t(i)*a/T) + 10/23*sin(9/20 - 120*t(i)*a/T) + 19/66*sin(21/13 - 118*t(i)*a/T) + 10/33*sin(11/16 - 117*t(i)*a/T) + 11/31*sin(51/26 - 116*t(i)*a/T) + 5/17*sin(79/34 - 115*t(i)*a/T) + 5/22*sin(59/28 - 113*t(i)*a/T) + 7/17*sin(91/58 - 112*t(i)*a/T) + 11/21*sin(124/53 - 110*t(i)*a/T) + 9/28*sin(19/31 - 107*t(i)*a/T) + 17/39*sin(1/36 - 106*t(i)*a/T) + 3/11*sin(2/31 - 105*t(i)*a/T) + 5/46*sin(80/17 - 104*t(i)*a/T) + 7/20*sin(97/22 - 103*t(i)*a/T) + 3/37*sin(320/71 - 101*t(i)*a/T) + 9/37*sin(193/96 - 100*t(i)*a/T) + 7/16*sin(31/38 - 99*t(i)*a/T) + 13/21*sin(8/25 - 98*t(i)*a/T) + 5/27*sin(158/37 - 97*t(i)*a/T) + 31/53*sin(70/31 - 95*t(i)*a/T) + 61/123*sin(10/11 - 93*t(i)*a/T) + 5/19*sin(84/29 - 92*t(i)*a/T) + 23/22*sin(97/21 - 88*t(i)*a/T) + 7/57*sin(32/33 - 86*t(i)*a/T) + 3/29*sin(105/31 - 84*t(i)*a/T) + 1/22*sin(35/17 - 81*t(i)*a/T) + 25/47*sin(13/14 - 80*t(i)*a/T) + 16/35*sin(35/8 - 79*t(i)*a/T) + 11/23*sin(29/17 - 78*t(i)*a/T) + 10/9*sin(88/25 - 77*t(i)*a/T) + 26/23*sin(61/15 - 76*t(i)*a/T) + 31/27*sin(121/30 - 75*t(i)*a/T) + 16/17*sin(41/28 - 73*t(i)*a/T) + 11/9*sin(73/18 - 71*t(i)*a/T) + 13/23*sin(149/37 - 68*t(i)*a/T) + 11/19*sin(12/11 - 67*t(i)*a/T) + 41/31*sin(15/14 - 66*t(i)*a/T) + 14/23*sin(74/17 - 65*t(i)*a/T) + 11/14*sin(3/20 - 64*t(i)*a/T) + 18/47*sin(218/97 - 63*t(i)*a/T) + 76/65*sin(61/17 - 62*t(i)*a/T) + 29/13*sin(106/59 - 60*t(i)*a/T) + 23/17*sin(85/43 - 59*t(i)*a/T) + 3/34*sin(70/29 - 58*t(i)*a/T) + 25/34*sin(27/11 - 57*t(i)*a/T) + 38/31*sin(29/13 - 56*t(i)*a/T) + 5/7*sin(77/116 - 55*t(i)*a/T) + 69/28*sin(256/85 - 54*t(i)*a/T) + 59/22*sin(92/37 - 53*t(i)*a/T) + 32/19*sin(109/32 - 52*t(i)*a/T) + 14/19*sin(21/31 - 51*t(i)*a/T) + 83/32*sin(47/27 - 50*t(i)*a/T) + 55/26*sin(52/51 - 49*t(i)*a/T) + 100/41*sin(33/28 - 46*t(i)*a/T) + 196/33*sin(53/18 - 45*t(i)*a/T) + 166/39*sin(24/17 - 44*t(i)*a/T) + 183/46*sin(341/171 - 43*t(i)*a/T) + 41/28*sin(72/31 - 42*t(i)*a/T) + 23/15*sin(43/47 - 41*t(i)*a/T) + 49/26*sin(47/34 - 40*t(i)*a/T) + 117/31*sin(63/23 - 39*t(i)*a/T) + 191/30*sin(541/135 - 38*t(i)*a/T) + 111/31*sin(72/19 - 37*t(i)*a/T) + 71/37*sin(74/35 - 36*t(i)*a/T) + 12/25*sin(137/35 - 34*t(i)*a/T) + 126/31*sin(13/29 - 33*t(i)*a/T) + 140/31*sin(184/41 - 32*t(i)*a/T) + 413/103*sin(11/23 - 31*t(i)*a/T) + 81/22*sin(48/37 - 30*t(i)*a/T) + 52/17*sin(22/13 - 29*t(i)*a/T) + 75/22*sin(17/36 - 28*t(i)*a/T) + 116/83*sin(38/21 - 27*t(i)*a/T) + 364/31*sin(62/23 - 26*t(i)*a/T) + 143/38*sin(127/29 - 25*t(i)*a/T) + 341/35*sin(31/34 - 23*t(i)*a/T) + 310/59*sin(31/8 - 21*t(i)*a/T) + 383/48*sin(173/38 - 20*t(i)*a/T) + 40/9*sin(67/20 - 19*t(i)*a/T) + 497/17*sin(61/47 - 16*t(i)*a/T) + 1426/47*sin(75/17 - 15*t(i)*a/T) + 1261/21*sin(17/28 - 12*t(i)*a/T) + 845/43*sin(119/38 - 11*t(i)*a/T) + 77/4*sin(96/29 - 10*t(i)*a/T) + 488/25*sin(10/27 - 8*t(i)*a/T) + 3103/36*sin(48/31 - 6*t(i)*a/T) + 3438/29*sin(13/33 - 5*t(i)*a/T) + 6317/32*sin(53/13 - 3*t(i)*a/T) + 8838/59*sin(62/27 - 2*t(i)*a/T) + 25066/31*sin(95/24 -t(i)*a/T) - 2577/41*sin(4*t(i)*a/T + 9/16) - 1840/29*sin(7*t(i)*a/T + 21/22) - 3249/35*sin(9*t(i)*a/T + 17/13) - 405/29*sin(13*t(i)*a/T + 18/29) - 909/43*sin(14*t(i)*a/T + 2/3) - 417/14*sin(17*t(i)*a/T + 8/19) - 57/10*sin(18*t(i)*a/T + 47/34) - 431/34*sin(22*t(i)*a/T + 3/46) - 79/19*sin(24*t(i)*a/T + 8/29) - 827/121*sin(35*t(i)*a/T + 47/37) - 43/27*sin(47*t(i)*a/T + 35/33) - 21/19*sin(48*t(i)*a/T + 16/15) - 10/11*sin(61*t(i)*a/T + 23/18) - 25/21*sin(69*t(i)*a/T + 4/19) - 51/103*sin(70*t(i)*a/T + 53/52) - 35/32*sin(72*t(i)*a/T + 24/29) - 42/31*sin(74*t(i)*a/T + 42/43) - 13/42*sin(82*t(i)*a/T + 95/63) - 13/16*sin(83*t(i)*a/T + 10/23) - 21/22*sin(85*t(i)*a/T + 54/53) - 35/38*sin(87*t(i)*a/T + 3/7) - 29/77*sin(89*t(i)*a/T + 57/49) - 17/25*sin(90*t(i)*a/T + 29/25) - 15/26*sin(91*t(i)*a/T + 4/5) - 8/13*sin(94*t(i)*a/T + 6/5) - 5/14*sin(96*t(i)*a/T + 80/81) - 3/23*sin(102*t(i)*a/T + 1/7) - 13/42*sin(108*t(i)*a/T + 39/25) - 3/11*sin(109*t(i)*a/T + 15/44) - 21/34*sin(111*t(i)*a/T + 20/13) - 24/47*sin(114*t(i)*a/T + 34/35) - 11/39*sin(119*t(i)*a/T + 7/23));
rz=0; 
r_d_t=[rx+ix-0.0356043455923348;ry+iy+0.0671241230055372;rz+iz];

dot_r_d_t =0.0001*[- (4775*a*cos((15*a*t(i))/T - 5/2))/(12*T) - (51202*a*cos((4*a*t(i))/T + 9/16))/(29*T) - (6029*a*cos((2*a*t(i))/T - 14/19))/(28*T) - (429*a*cos((24*a*t(i))/T + 1/14))/(2*T) - (17980*a*cos((5*a*t(i))/T - 5/39))/(21*T) - (13431*a*cos((11*a*t(i))/T - 27/13))/(34*T) - (464*a*cos((48*a*t(i))/T + 1/6))/(11*T) - (52209*a*cos((9*a*t(i))/T + 17/30))/(100*T) - (4256*a*cos((21*a*t(i))/T - 22/13))/(11*T) - (6048*a*cos((18*a*t(i))/T - 17/29))/(17*T) - (12293*a*cos((19*a*t(i))/T - 32/15))/(27*T) - (71761*a*cos((a*t)/T - 49/20))/(66*T) - (1023*a*cos((31*a*t(i))/T + 16/23))/(13*T) - (1224*a*cos((68*a*t(i))/T + 3/7))/(11*T) - (306*a*cos((51*a*t(i))/T + 6/23))/(11*T) - (870*a*cos((60*a*t(i))/T - 1/22))/(17*T) - (6226*a*cos((22*a*t(i))/T + 37/28))/(35*T) - (9592*a*cos((44*a*t(i))/T + 14/31))/(67*T) - (1584*a*cos((66*a*t(i))/T + 13/11))/(43*T) - (8253*a*cos((7*a*t(i))/T + 42/43))/(8*T) - (2200*a*cos((40*a*t(i))/T - 39/14))/(41*T) - (1716*a*cos((39*a*t(i))/T - 23/32))/(19*T) - (19452*a*cos((12*a*t(i))/T - 33/50))/(35*T) - (420*a*cos((56*a*t(i))/T - 14/25))/(13*T) - (1110*a*cos((45*a*t(i))/T + 28/23))/(13*T) - (5648*a*cos((16*a*t(i))/T - 28/55))/(35*T) - (2650*a*cos((25*a*t(i))/T - 38/37))/(19*T) - (1568*a*cos((64*a*t(i))/T + 15/22))/(25*T) - (1808*a*cos((6*a*t(i))/T - 55/42))/(11*T) - (5248*a*cos((41*a*t(i))/T + 37/30))/(25*T) - (400*a*cos((75*a*t(i))/T - 19/15))/(7*T) - (2148*a*cos((3*a*t(i))/T - 88/21))/(5*T) - (828*a*cos((92*a*t(i))/T + 9/11))/(25*T) - (243*a*cos((42*a*t(i))/T - 58/13))/(2*T) - (2726*a*cos((47*a*t(i))/T - 45/22))/(39*T) - (1917*a*cos((71*a*t(i))/T - 25/18))/(29*T) - (10088*a*cos((8*a*t(i))/T - 71/38))/(19*T) - (1185*a*cos((79*a*t(i))/T + 1/37))/(16*T) - (238*a*cos((84*a*t(i))/T - 25/8))/(3*T) - (2673*a*cos((81*a*t(i))/T + 19/25))/(38*T) - (2065*a*cos((59*a*t(i))/T + 37/33))/(26*T) - (6944*a*cos((62*a*t(i))/T - 22/45))/(39*T) - (988*a*cos((76*a*t(i))/T + 32/23))/(23*T) - (3488*a*cos((109*a*t(i))/T - 18/5))/(53*T) - (3233*a*cos((53*a*t(i))/T + 23/57))/(26*T) - (318*a*cos((106*a*t(i))/T - 4/23))/(23*T) - (3144*a*cos((72*a*t(i))/T - 49/13))/(25*T) - (4439*a*cos((23*a*t(i))/T - 81/34))/(26*T) - (915*a*cos((61*a*t(i))/T - 43/35))/(23*T) - (1089*a*cos((121*a*t(i))/T + 2/19))/(35*T) - (129*a*cos((86*a*t(i))/T - 46/11))/(4*T) - (816*a*cos((102*a*t(i))/T - 23/19))/(13*T) - (840*a*cos((105*a*t(i))/T - 25/14))/(17*T) - (1740*a*cos((58*a*t(i))/T - 65/22))/(43*T) - (364*a*cos((104*a*t(i))/T + 11/30))/(23*T) - (5684*a*cos((29*a*t(i))/T - 59/58))/(41*T) - (459*a*cos((54*a*t(i))/T + 25/67))/(5*T) - (1690*a*cos((65*a*t(i))/T - 61/22))/(29*T) - (1314*a*cos((27*a*t(i))/T - 97/25))/(13*T) - (728*a*cos((52*a*t(i))/T - 69/28))/(43*T) - (1540*a*cos((55*a*t(i))/T - 53/43))/(23*T) - (560*a*cos((112*a*t(i))/T - 16/23))/(29*T) - (12922*a*cos((14*a*t(i))/T - 112/27))/(43*T) - (107*a*cos((107*a*t(i))/T - 13/33))/(8*T) - (2478*a*cos((118*a*t(i))/T + 6/29))/(37*T) - (361*a*cos((57*a*t(i))/T - 75/23))/(10*T) - (5134*a*cos((34*a*t(i))/T - 91/31))/(55*T) - (931*a*cos((35*a*t(i))/T - 79/45))/(6*T) - (110*a*cos((110*a*t(i))/T - 20/29))/(27*T) - (3626*a*cos((37*a*t(i))/T - 101/24))/(31*T) - (3827*a*cos((89*a*t(i))/T - 56/17))/(42*T) - (7684*a*cos((17*a*t(i))/T - 119/27))/(35*T) - (5643*a*cos((33*a*t(i))/T - 104/27))/(28*T) - (912*a*cos((114*a*t(i))/T - 27/25))/(23*T) - (716*a*cos((36*a*t(i))/T + 1/130))/(3*T) - (171*a*cos((90*a*t(i))/T - 43/36))/(4*T) - (451*a*cos((99*a*t(i))/T - 26/47))/(9*T) - (1591*a*cos((43*a*t(i))/T - 103/30))/(18*T) - (1876*a*cos((28*a*t(i))/T - 122/27))/(15*T) - (1045*a*cos((95*a*t(i))/T - 68/15))/(24*T) - (55*a*cos((88*a*t(i))/T - 51/40))/T - (2162*a*cos((46*a*t(i))/T - 106/33))/(17*T) - (517*a*cos((94*a*t(i))/T - 44/49))/(7*T) - (707*a*cos((101*a*t(i))/T - 37/52))/(12*T) - (432*a*cos((108*a*t(i))/T - 65/24))/(19*T) - (1044*a*cos((116*a*t(i))/T + 28/55))/(49*T) - (1898*a*cos((73*a*t(i))/T - 85/43))/(31*T) - (1309*a*cos((77*a*t(i))/T - 86/41))/(37*T) - (539*a*cos((98*a*t(i))/T - 47/59))/(20*T) - (1648*a*cos((103*a*t(i))/T + 48/55))/(29*T) - (2109*a*cos((111*a*t(i))/T - 64/31))/(28*T) - (25180*a*cos((10*a*t(i))/T + 118/79))/(29*T) - (3007*a*cos((97*a*t(i))/T - 73/40))/(35*T) - (390*a*cos((78*a*t(i))/T - 105/29))/(7*T) - (333*a*cos((74*a*t(i))/T - 101/42))/(4*T) - (425*a*cos((85*a*t(i))/T - 115/33))/(18*T) - (1170*a*cos((117*a*t(i))/T - 86/31))/(31*T) - (305*a*cos((30*a*t(i))/T - 170/37))/(2*T) - (364*a*cos((91*a*t(i))/T - 121/28))/(25*T) - (1305*a*cos((87*a*t(i))/T - 121/34))/(31*T) - (3968*a*cos((32*a*t(i))/T - 155/58))/(17*T) - (2240*a*cos((70*a*t(i))/T - 135/47))/(31*T) - (1017*a*cos((113*a*t(i))/T - 99/40))/(31*T) - (207*a*cos((63*a*t(i))/T - 135/58))/(4*T) - (6409*a*cos((13*a*t(i))/T - 200/47))/(33*T) - (1679*a*cos((69*a*t(i))/T - 153/43))/(10*T) - (528*a*cos((96*a*t(i))/T - 141/32))/(17*T) - (1035*a*cos((115*a*t(i))/T - 123/35))/(32*T) - (3040*a*cos((80*a*t(i))/T - 162/35))/(39*T) - (279*a*cos((93*a*t(i))/T - 141/53))/(35*T) - (2499*a*cos((119*a*t(i))/T - 137/34))/(52*T) - (77444*a*cos((38*a*t(i))/T - 173/87))/(291*T) - (2058*a*cos((49*a*t(i))/T - 211/45))/(37*T) - (67*a*cos((67*a*t(i))/T - 197/42))/(12*T) - (2160*a*cos((120*a*t(i))/T - 161/41))/(29*T) - (3608*a*cos((82*a*t(i))/T - 187/58))/(43*T) - (800*a*cos((100*a*t(i))/T - 192/41))/(29*T) - (3071*a*cos((83*a*t(i))/T - 248/59))/(33*T) - (832*a*cos((26*a*t(i))/T + 1/376))/(7*T) - (1940*a*cos((20*a*t(i))/T - 321/320))/(33*T) - (2500*a*cos((50*a*t(i))/T - 1623/406))/(37*T);
    - (12726*a*cos((14*a*t(i))/T + 2/3))/(43*T) - (10308*a*cos((4*a*t(i))/T + 9/16))/(41*T) - (29241*a*cos((9*a*t(i))/T + 17/13))/(35*T) - (7089*a*cos((17*a*t(i))/T + 8/19))/(14*T) - (3904*a*cos((8*a*t(i))/T - 10/27))/(25*T) - (12880*a*cos((7*a*t(i))/T + 21/22))/(29*T) - (17190*a*cos((5*a*t(i))/T - 13/33))/(29*T) - (5044*a*cos((12*a*t(i))/T - 17/28))/(7*T) - (5265*a*cos((13*a*t(i))/T + 18/29))/(29*T) - (6510*a*cos((21*a*t(i))/T - 31/8))/(59*T) - (1896*a*cos((24*a*t(i))/T + 8/29))/(19*T) - (1508*a*cos((29*a*t(i))/T - 22/13))/(17*T) - (12803*a*cos((31*a*t(i))/T - 11/23))/(103*T) - (18951*a*cos((3*a*t(i))/T - 53/13))/(32*T) - (4741*a*cos((22*a*t(i))/T + 3/46))/(17*T) - (4158*a*cos((33*a*t(i))/T - 13/29))/(31*T) - (1008*a*cos((48*a*t(i))/T + 16/15))/(19*T) - (1050*a*cos((28*a*t(i))/T - 17/36))/(11*T) - (3103*a*cos((6*a*t(i))/T - 48/31))/(6*T) - (7304*a*cos((44*a*t(i))/T - 24/17))/(39*T) - (3132*a*cos((27*a*t(i))/T - 38/21))/(83*T) - (352*a*cos((64*a*t(i))/T - 3/20))/(7*T) - (7843*a*cos((23*a*t(i))/T - 31/34))/(35*T) - (737*a*cos((67*a*t(i))/T - 12/11))/(19*T) - (17676*a*cos((2*a*t(i))/T - 62/27))/(59*T) - (575*a*cos((69*a*t(i))/T + 4/19))/(7*T) - (1425*a*cos((57*a*t(i))/T - 27/11))/(34*T) - (2706*a*cos((66*a*t(i))/T - 15/14))/(31*T) - (3045*a*cos((87*a*t(i))/T + 3/7))/(38*T) - (2128*a*cos((56*a*t(i))/T - 29/13))/(31*T) - (513*a*cos((18*a*t(i))/T + 47/34))/(5*T) - (105*a*cos((91*a*t(i))/T + 4/5))/(2*T) - (610*a*cos((61*a*t(i))/T + 23/18))/(11*T) - (714*a*cos((51*a*t(i))/T - 21/31))/(19*T) - (752*a*cos((94*a*t(i))/T + 6/5))/(13*T) - (760*a*cos((19*a*t(i))/T - 67/20))/(9*T) - (21390*a*cos((15*a*t(i))/T - 75/17))/(47*T) - (4600*a*cos((46*a*t(i))/T - 33/28))/(41*T) - (2000*a*cos((80*a*t(i))/T - 13/14))/(47*T) - (306*a*cos((102*a*t(i))/T + 1/7))/(23*T) - (9464*a*cos((26*a*t(i))/T - 62/23))/(31*T) - (1891*a*cos((93*a*t(i))/T - 10/11))/(41*T) - (1215*a*cos((30*a*t(i))/T - 48/37))/(11*T) - (2021*a*cos((47*a*t(i))/T + 35/33))/(27*T) - (2940*a*cos((45*a*t(i))/T - 53/18))/(11*T) - (1079*a*cos((83*a*t(i))/T + 10/23))/(16*T) - (25066*a*cos((a*t)/T - 95/24))/(31*T) - (28945*a*cos((35*a*t(i))/T + 47/37))/(121*T) - (980*a*cos((40*a*t(i))/T - 47/34))/(13*T) - (1264*a*cos((79*a*t(i))/T - 35/8))/(35*T) - (7952*a*cos((16*a*t(i))/T - 61/47))/(17*T) - (2075*a*cos((50*a*t(i))/T - 47/27))/(16*T) - (858*a*cos((78*a*t(i))/T - 29/17))/(23*T) - (4563*a*cos((39*a*t(i))/T - 63/23))/(31*T) - (315*a*cos((72*a*t(i))/T + 24/29))/(4*T) - (4107*a*cos((37*a*t(i))/T - 72/19))/(31*T) - (943*a*cos((41*a*t(i))/T - 43/47))/(15*T) - (182*a*cos((98*a*t(i))/T - 8/25))/(3*T) - (81*a*cos((81*a*t(i))/T - 35/17))/(22*T) - (385*a*cos((10*a*t(i))/T - 96/29))/(2*T) - (315*a*cos((105*a*t(i))/T - 2/31))/(11*T) - (4712*a*cos((62*a*t(i))/T - 61/17))/(65*T) - (1168*a*cos((73*a*t(i))/T - 41/28))/(17*T) - (1802*a*cos((106*a*t(i))/T - 1/36))/(39*T) - (306*a*cos((90*a*t(i))/T + 29/25))/(5*T) - (2331*a*cos((111*a*t(i))/T + 20/13))/(34*T) - (390*a*cos((117*a*t(i))/T - 11/16))/(11*T) - (2556*a*cos((36*a*t(i))/T - 74/35))/(37*T) - (123*a*cos((42*a*t(i))/T - 72/31))/(2*T) - (1309*a*cos((119*a*t(i))/T + 7/23))/(39*T) - (1200*a*cos((120*a*t(i))/T - 9/20))/(23*T) - (602*a*cos((86*a*t(i))/T - 32/33))/(57*T) - (2695*a*cos((49*a*t(i))/T - 52/51))/(26*T) - (1976*a*cos((76*a*t(i))/T - 61/15))/(23*T) - (1121*a*cos((118*a*t(i))/T - 21/13))/(33*T) - (910*a*cos((65*a*t(i))/T - 74/17))/(23*T) - (87*a*cos((58*a*t(i))/T - 70/29))/(17*T) - (963*a*cos((107*a*t(i))/T - 19/31))/(28*T) - (3108*a*cos((74*a*t(i))/T + 42/43))/(31*T) - (781*a*cos((71*a*t(i))/T - 73/18))/(9*T) - (9295*a*cos((11*a*t(i))/T - 119/38))/(43*T) - (693*a*cos((99*a*t(i))/T - 31/38))/(16*T) - (327*a*cos((109*a*t(i))/T + 15/44))/(11*T) - (234*a*cos((108*a*t(i))/T + 39/25))/(7*T) - (3570*a*cos((70*a*t(i))/T + 53/52))/(103*T) - (3575*a*cos((25*a*t(i))/T - 127/29))/(38*T) - (3127*a*cos((53*a*t(i))/T - 92/37))/(22*T) - (2736*a*cos((114*a*t(i))/T + 34/35))/(47*T) - (1357*a*cos((59*a*t(i))/T - 85/43))/(17*T) - (770*a*cos((77*a*t(i))/T - 88/25))/(9*T) - (1785*a*cos((85*a*t(i))/T + 54/53))/(22*T) - (3751*a*cos((121*a*t(i))/T - 54/17))/(94*T) - (1664*a*cos((52*a*t(i))/T - 109/32))/(19*T) - (1276*a*cos((116*a*t(i))/T - 51/26))/(31*T) - (2581*a*cos((89*a*t(i))/T + 57/49))/(77*T) - (2945*a*cos((95*a*t(i))/T - 70/31))/(53*T) - (565*a*cos((113*a*t(i))/T - 59/28))/(22*T) - (260*a*cos((104*a*t(i))/T - 80/17))/(23*T) - (460*a*cos((92*a*t(i))/T - 84/29))/(19*T) - (408*a*cos((34*a*t(i))/T - 137/35))/(25*T) - (92*a*cos((88*a*t(i))/T - 97/21))/T - (252*a*cos((84*a*t(i))/T - 105/31))/(29*T) - (721*a*cos((103*a*t(i))/T - 97/22))/(20*T) - (1740*a*cos((60*a*t(i))/T - 106/59))/(13*T) - (775*a*cos((75*a*t(i))/T - 121/30))/(9*T) - (575*a*cos((115*a*t(i))/T - 79/34))/(17*T) - (1915*a*cos((20*a*t(i))/T - 173/38))/(12*T) - (533*a*cos((82*a*t(i))/T + 95/63))/(21*T) - (275*a*cos((55*a*t(i))/T - 77/116))/(7*T) - (884*a*cos((68*a*t(i))/T - 149/37))/(23*T) - (4480*a*cos((32*a*t(i))/T - 184/41))/(31*T) - (240*a*cos((96*a*t(i))/T + 80/81))/(7*T) - (784*a*cos((112*a*t(i))/T - 91/58))/(17*T) - (1210*a*cos((110*a*t(i))/T - 124/53))/(21*T) - (485*a*cos((97*a*t(i))/T - 158/37))/(27*T) - (1134*a*cos((63*a*t(i))/T - 218/97))/(47*T) - (900*a*cos((100*a*t(i))/T - 193/96))/(37*T) - (1863*a*cos((54*a*t(i))/T - 256/85))/(14*T) - (303*a*cos((101*a*t(i))/T - 320/71))/(37*T) - (7869*a*cos((43*a*t(i))/T - 341/171))/(46*T) - (3629*a*cos((38*a*t(i))/T - 541/135))/(15*T);
    0]; 


%  末端的误差
e=r-r_d_t;

r_d_t_store(i,1)=r_d_t(1,1);
r_d_t_store(i,2)=r_d_t(2,1);
r_d_t_store(i,3)=r_d_t(3,1);

dot_r_d_t_store(i,1)=dot_r_d_t(1,1);
dot_r_d_t_store(i,2)=dot_r_d_t(2,1);
dot_r_d_t_store(i,3)=dot_r_d_t(3,1);

r_store(i,:)=r';
e_store(i,:)=e';

end
figure(1);
plot(t,u1(:,m+n+p+1:n+m+p+m));  %theta
legend('q1','q2','q3','q4','q5','q6','q7');
title('Simulated left robot theta');
 
figure(2);
plot(t,u1(:,1:m)); %dot_theta
xlabel('t/s')
ylabel('u/rad/s')
legend('dt1','dt2','dt3','dt4','dt5','dt6','dt7','Location','northeast','NumColumns',4);
title('Simulated left robot joint velocity');

figure(3),hold on
h=plot3(r_d_t_store(:,1),r_d_t_store(:,2),r_d_t_store(:,3),'b');
h=plot3(r_store(:,1),r_store(:,2),r_store(:,3),'r');
set(h,'linewidth',3);
% xlabel('X');
% ylabel('Y');
% zlabel('Z');
% legend('left Desired trajectory ','left End-effector trajectory');


fig=figure(4),clf(4),
plot(t,e_store(:,1:3));
title('left e=r-r_d')
% xlabel('t/s')
% ylabel('e/m')
% legend('ex','ey','ez');

%动画
for i=1:20:length(tspan)
r1=P1(u1(i,:));j1px(i,1)=r1(1,1);j1py(i,1)=r1(2,1);j1pz(i,1)=r1(3,1);
r2=P2(u1(i,:));j2px(i,1)=r2(1,1);j2py(i,1)=r2(2,1);j2pz(i,1)=r2(3,1);
r3=P3(u1(i,:));j3px(i,1)=r3(1,1);j3py(i,1)=r3(2,1);j3pz(i,1)=r3(3,1);
r4=P4(u1(i,:));j4px(i,1)=r4(1,1);j4py(i,1)=r4(2,1);j4pz(i,1)=r4(3,1);
r5=P5(u1(i,:));j5px(i,1)=r5(1,1);j5py(i,1)=r5(2,1);j5pz(i,1)=r5(3,1);
r6=P6(u1(i,:));j6px(i,1)=r6(1,1);j6py(i,1)=r6(2,1);j6pz(i,1)=r6(3,1);
r7=P7(u1(i,:));j7px(i,1)=r7(1,1);j7py(i,1)=r7(2,1);j7pz(i,1)=r6(3,1);
end

figure(5)
plot3(r_store(:,1),r_store(:,2),r_store(:,3),'r','LineWidth',5);hold on;
% plot3(r_d_t_store(:,1),r_d_t_store(:,2),r_d_t_store(:,3),'color', '[0.8500 0.3250 0.0980]','LineWidth',5);
hold on;

for j=1:20:length(tspan)
 
    joints12=line('xdata',[j1px(j);j2px(j)],'ydata',[j1py(j);j2py(j)],'zdata',[j1pz(j);j2pz(j)],...
        'color', '[0.9290 0.6940 0.1250]','erasemode','none');
    joints23=line('xdata',[j2px(j);j3px(j)],'ydata',[j2py(j);j3py(j)],'zdata',[j2pz(j);j3pz(j)],...
        'color', '[0.9290 0.6940 0.1250]','erasemode','none');
    joints34=line('xdata',[j3px(j);j4px(j)],'ydata',[j3py(j);j4py(j)],'zdata',[j3pz(j);j4pz(j)],...
         'color', '[0.9290 0.6940 0.1250]','erasemode','none');
    joints45=line('xdata',[j4px(j);j5px(j)],'ydata',[j4py(j);j5py(j)],'zdata',[j4pz(j);j5pz(j)],...
        'color', '[0.9290 0.6940 0.1250]','erasemode','none');
    joints56=line('xdata',[j5px(j);j6px(j)],'ydata',[j5py(j);j6py(j)],'zdata',[j5pz(j);j6pz(j)],...
       'color', '[0.9290 0.6940 0.1250]','erasemode','none');
     joints67=line('xdata',[j6px(j);r_store((j),1)],'ydata',[j6py(j);r_store((j),2)],'zdata',[j6pz(j);r_store((j),3)],...
        'color', '[0.9290 0.6940 0.1250]','erasemode','none');
    drawnow
end
grid on;
ax=gca;
% ax.FontSize = 20;
set(gca,'FontSize',30);
hold on
% ax.XLim = [-0.5 0.5];
% ax.YLim = [-0.2,0.2];
% ax.ZLim = [0 1];
% text(-0.2,0.07,0.25,'X(m)');text(0.5,0,0.25,'Y(m)');text(0.4,-0.1,0.7,'Z(m)'); 
for i=1:length(tspan)
  
      NORM1(i)=norm(u1(i,1:m)'*u1(i,1:m),inf);
      rd(i,1:n)=franka_Jacb(theta)*u1(i,1:m)';
end
figure(6)
plot(t, rd(:,1:n));
legend('x','y','z');
title('End_Velocity');
figure(7)
plot(t, NORM1(:));

